{% extends 'base.html' %}
{% block content %}

<div class="shared-wrapper">
  <h1>Shared Files</h1>
  <p>Files you've shared with others</p>

  <!-- SUMMARY -->
  <div class="stats-bar">
    <div><h2 id="totalShared">0</h2><span>Total Shared</span></div>
    <div><h2 id="downloadedFiles">0</h2><span>Downloaded</span></div>
    <div><h2 id="totalDownloads">0</h2><span>Total Downloads</span></div>
    <div><h2 id="totalViews">0</h2><span>Total Views</span></div>
  </div>

  <!-- TABLE -->
  <table class="shared-table">
    <thead>
      <tr>
        <th>File Name</th>
        <th>Size</th>
        <th>Downloads</th>
        <th>Views</th>
        <th>Created</th>
        <th>Expires</th>
        <th>Share Link</th>
      </tr>
    </thead>
    <tbody id="sharedTable">
      <tr><td colspan="7">Loading...</td></tr>
    </tbody>
  </table>
</div>

<script>
const API_BASE = "https://dropvault-2.onrender.com";

async function loadSharedFiles() {
  try {
    const res = await fetch(`${API_BASE}/api/shared/`, {
      credentials: "include"
    });

    const data = await res.json();

    if (data.login_required) {
      alert("Session expired. Please login again.");
      return location.href = "/login";
    }

    const files =
      data.shared_files ||
      data.shared ||
      data.files ||
      [];

    // ---------- STATS ----------
    document.getElementById("totalShared").innerText = files.length;

    let downloaded = 0;
    let totalDownloads = 0;
    let totalViews = 0;

    files.forEach(f => {
      if (f.downloads > 0) downloaded++;
      totalDownloads += f.downloads || 0;
      totalViews += f.views || 0;
    });

    document.getElementById("downloadedFiles").innerText = downloaded;
    document.getElementById("totalDownloads").innerText = totalDownloads;
    document.getElementById("totalViews").innerText = totalViews;

    // ---------- TABLE ----------
    const table = document.getElementById("sharedTable");
    table.innerHTML = "";

    if (!files.length) {
      table.innerHTML = `<tr><td colspan="7">No shared files</td></tr>`;
      return;
    }

    files.forEach(f => {
      const shareURL = `${API_BASE}/s/${f.share_key}/`;
      table.innerHTML += `
        <tr>
          <td>${f.filename}</td>
          <td>${(f.size || 0).toFixed(2)} MB</td>
          <td>${f.downloads || 0} / ${f.max_downloads || "âˆž"}</td>
          <td>${f.views || 0}</td>
          <td>${new Date(f.created_at).toLocaleString()}</td>
          <td>${new Date(f.expiry).toLocaleString()}</td>
          <td>
            <button onclick="copyLink('${shareURL}')">Copy Link</button>
          </td>
        </tr>
      `;
    });

  } catch (err) {
    console.error(err);
    document.getElementById("sharedTable").innerHTML =
      `<tr><td colspan="7">Error loading shared files</td></tr>`;
  }
}

function copyLink(url) {
  navigator.clipboard.writeText(url);
  alert("ðŸ”— Link copied!");
}

loadSharedFiles();
</script>

{% endblock %}
