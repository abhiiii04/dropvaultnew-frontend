{% extends "base.html" %}
{% block content %}

<style>
:root {
  --primary: #6366f1;
  --bg: #f6f8fc;
}

/* ================= LAYOUT ================= */
.dashboard {
  margin-left: 240px;
  padding: 40px;
  background: var(--bg);
  min-height: 100vh;
}

/* ================= TOP BAR ================= */
.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
}

.search {
  background: #fff;
  padding: 12px 18px;
  border-radius: 14px;
  width: 360px;
}

.actions {
  display: flex;
  gap: 18px;
  align-items: center;
}

.icon-btn {
  cursor: pointer;
  position: relative;
}

/* ================= DROPDOWNS ================= */
.dropdown {
  position: absolute;
  right: 0;
  top: 40px;
  width: 280px;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 12px 30px rgba(0,0,0,.1);
  display: none;
  z-index: 1000;
}

.dropdown.show { display: block; }

.dropdown h4 {
  padding: 14px;
  border-bottom: 1px solid #eee;
}

.dropdown ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.dropdown li {
  padding: 12px 16px;
  cursor: pointer;
}

.dropdown li:hover { background: #f3f4f6; }

/* ================= PROFILE ================= */
.profile {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
}

.avatar {
  width: 38px;
  height: 38px;
  background: linear-gradient(135deg,#6366f1,#8b5cf6);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-weight: 700;
}

/* ================= CARDS ================= */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap: 22px;
  margin-bottom: 30px;
}

.card {
  background: #fff;
  border-radius: 18px;
  padding: 20px;
}

.progress {
  background: #e5e7eb;
  height: 8px;
  border-radius: 6px;
  overflow: hidden;
  margin-top: 10px;
}

.progress div {
  height: 100%;
  background: var(--primary);
}

/* ================= FILE GRID ================= */
.file-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
  gap: 22px;
}

.file-card {
  background: #fff;
  border-radius: 18px;
  padding: 18px;
  cursor: pointer;
}

.file-card:hover { transform: translateY(-3px); }

.file-icon {
  width: 56px;
  height: 56px;
  background: #f3f4f6;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 10px;
}

.file-name {
  font-weight: 600;
  text-align: center;
}

.file-meta {
  text-align: center;
  font-size: 13px;
  color: #6b7280;
}

/* ================= MODAL ================= */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  display: none;
  align-items: center;
  justify-content: center;
}

.modal.show { display: flex; }

.modal-box {
  background: #fff;
  border-radius: 18px;
  padding: 20px;
  width: 80%;
  max-width: 800px;
}

.modal-box iframe,
.modal-box img {
  width: 100%;
  height: 500px;
  border-radius: 12px;
}

/* ================= ACTIVITY ================= */
.timeline {
  background: #fff;
  border-radius: 18px;
  padding: 22px;
  margin-top: 30px;
}

.timeline-item {
  display: flex;
  gap: 12px;
  margin-bottom: 14px;
}

.dot {
  width: 8px;
  height: 8px;
  background: var(--primary);
  border-radius: 50%;
  margin-top: 6px;
}
</style>

<div class="dashboard">

  <!-- TOP BAR -->
  <div class="top-bar">
    <input class="search" placeholder="Search your files..." />

    <div class="actions">

      <!-- NOTIFICATIONS -->
      <div class="icon-btn" onclick="toggleNotif()">
        ðŸ”” <span id="notifCount">0</span>
        <div class="dropdown" id="notifDropdown">
          <h4>Notifications</h4>
          <ul id="notifList"><li>Loading...</li></ul>
        </div>
      </div>

      <!-- PROFILE -->
      <div class="profile" onclick="toggleProfile()">
        <div class="avatar" id="avatar">U</div>
        <strong id="profileName" style="color:#000;">User</strong>
        <div class="dropdown" id="profileDropdown">
          <ul>
            <li onclick="location.href='/settings'">Settings</li>
            <li onclick="logout()">Logout</li>
          </ul>
        </div>
      </div>

    </div>
  </div>

  <!-- STATS -->
  <div class="cards">
    <div class="card">
      <h4>Storage Used</h4>
      <p id="storageText">0 / 0 GB</p>
      <div class="progress"><div id="storageBar"></div></div>
    </div>
    <div class="card"><h4>Total Files</h4><h2 id="totalFiles">0</h2></div>
    <div class="card"><h4>Shared Files</h4><h2 id="sharedCount">0</h2></div>
    <div class="card"><h4>Notifications</h4><h2 id="notifTotal">0</h2></div>
  </div>

  <!-- FILES -->
  <h2>Recent Files</h2>
  <div class="file-grid" id="fileGrid">Loading...</div>

  <!-- ACTIVITY -->
  <div class="timeline">
    <h3>Recent Activity</h3>
    <div id="activityList">Loading...</div>
  </div>

</div>

<!-- PREVIEW MODAL -->
<div class="modal" id="previewModal" onclick="closePreview(event)">
  <div class="modal-box" id="previewContent"></div>
</div>

<script>
const API = "https://dropvault-2.onrender.com";
const token = localStorage.getItem("token");

/* ================= TOGGLES ================= */
function toggleNotif() {
  notifDropdown.classList.toggle("show");
  profileDropdown.classList.remove("show");
}
function toggleProfile() {
  profileDropdown.classList.toggle("show");
  notifDropdown.classList.remove("show");
}
document.addEventListener("click",e=>{
  if(!e.target.closest(".icon-btn")) notifDropdown.classList.remove("show");
  if(!e.target.closest(".profile")) profileDropdown.classList.remove("show");
});

/* ================= PROFILE ================= */
fetch(`${API}/api/user/profile/`,{headers:{Authorization:token},credentials:"include"})
.then(r=>r.json()).then(u=>{
  profileName.innerText = u.username || u.email;
  avatar.innerText = (u.username||u.email)[0].toUpperCase();
});

/* ================= STORAGE ================= */
fetch(`${API}/api/user/storage/`,{headers:{Authorization:token},credentials:"include"})
.then(r=>r.json()).then(s=>{
  const used = (s.used_bytes/1024/1024/1024).toFixed(2);
  const total = (s.total_bytes/1024/1024/1024).toFixed(2);
  storageText.innerHTML = `<strong>${used} GB</strong> / ${total} GB`;
  storageBar.style.width = `${(s.used_bytes/s.total_bytes)*100}%`;
});

/* ================= FILES ================= */
fetch(`${API}/api/files/`,{headers:{Authorization:token},credentials:"include"})
.then(r=>r.json()).then(d=>{
  const files = d.files||[];
  totalFiles.innerText = files.length;
  fileGrid.innerHTML = "";
  files.slice(0,6).forEach(f=>{
    fileGrid.innerHTML+=`
      <div class="file-card" onclick="previewFile(${f.id},'${f.filename}')">
        <div class="file-icon">ðŸ“„</div>
        <div class="file-name">${f.filename}</div>
        <div class="file-meta">${(f.size_bytes/1024/1024).toFixed(2)} MB</div>
      </div>`;
  });
});

/* ================= PREVIEW ================= */
function previewFile(id,name){
  const ext=name.split(".").pop();
  let html=`<iframe src="${API}/api/download/${id}/"></iframe>`;
  if(["png","jpg","jpeg","gif"].includes(ext))
    html=`<img src="${API}/api/download/${id}/">`;
  previewContent.innerHTML=html;
  previewModal.classList.add("show");
}
function closePreview(e){ if(e.target.id==="previewModal") previewModal.classList.remove("show"); }

/* ================= NOTIFICATIONS ================= */
fetch(`${API}/api/notifications/`,{headers:{Authorization:token},credentials:"include"})
.then(r=>r.json()).then(n=>{
  notifCount.innerText=n.length;
  notifTotal.innerText=n.length;
  notifList.innerHTML=n.length?n.map(x=>`<li>${x.message}</li>`).join(""):"<li>No notifications</li>";
});

/* ================= ACTIVITY ================= */
Promise.all([
  fetch(`${API}/api/files/`,{headers:{Authorization:token},credentials:"include"}).then(r=>r.json()),
  fetch(`${API}/api/shared/`,{credentials:"include"}).then(r=>r.json())
]).then(([f,s])=>{
  const events=[];
  (f.files||[]).slice(0,4).forEach(x=>events.push(`Uploaded ${x.filename}`));
  (s.shared||[]).slice(0,4).forEach(x=>events.push(`Shared ${x.filename||"file"}`));
  activityList.innerHTML=events.map(e=>`
    <div class="timeline-item"><div class="dot"></div><div>${e}</div></div>`).join("");
});

/* ================= LOGOUT ================= */
function logout(){localStorage.clear();location.href="/login";}
</script>

{% endblock %}
