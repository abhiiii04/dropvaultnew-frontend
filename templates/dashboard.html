{% extends "base.html" %}
{% bendblocktent %}
<div class="main">
  <h1>Welcome to DropVault</h1>
  <p>Secure. Simple. Yours.</p>

  <div class="dashboard-cards">
    <div class="card">
      <h3>Storage Used</h3>
      <p id="storageText"><strong>0 GB</strong> / 0 GB used</p>
      <div class="progress-container">
        <div class="progress-bar" id="storageBar" style="width: 0%;"></div>
      </div>
    </div>

    <div class="card">
      <h3>Recent Uploads</h3>
      <ul id="recentUploads"><li>Loading...</li></ul>
    </div>

    <div class="card">
      <h3>Shared Files</h3>
      <p id="sharedCount">0 shared this week</p>
    </div>
  </div>

  <div class="table-section">
    <h2>Your Files</h2>
    <table class="dashboard-table">
      <thead>
        <tr>
          <th>Filename</th>
          <th>Expires</th>
          <th>Link</th>
          <th>Download</th>
          <th>QR</th>
        </tr>
      </thead>
      <tbody id="fileTable">
        <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const API_BASE = "https://dropvault-2.onrender.com"; // backend

async function loadDashboard(){
  const token = localStorage.getItem("token");
  if (!token) return window.location.href = "/login";

  const res = await fetch(`${API_BASE}/dashboard/`, {
    method: "GET",
    headers: { "Authorization": token }
  });

  const data = await res.json();
  console.log("DASHBOARD DATA:", data);

  // ---- STORAGE ----
  document.getElementById("storageText").innerHTML =
    `<strong>${data.storage.used} GB</strong> / ${data.storage.total} GB used`;
  document.getElementById("storageBar").style.width = `${data.storage.percent}%`;

  // ---- RECENT FILES ----
  const recentUI = document.getElementById("recentUploads");
  recentUI.innerHTML = "";
  data.recent_files.forEach(f => {
    recentUI.innerHTML += `<li>${f}</li>`;
  });

  // ---- SHARED COUNT ----
  document.getElementById("sharedCount").innerText = `${data.shared_count} shared this week`;

  // ---- FILE LIST ----
  const table = document.getElementById("fileTable");
  table.innerHTML = "";
  data.files.forEach(f => {
    table.innerHTML += `
      <tr>
        <td>${f.filename}</td>
        <td>${f.expiry}</td>
        <td><a href="${f.download_url}" target="_blank">Open</a></td>
        <td><a href="${f.download_url}" class="btn small">⬇️</a></td>
        <td><img src="${f.qr}" class="qr-small" alt="QR"></td>
      </tr>
    `;
  });
}

loadDashboard();
</script>

{% endblock %}
