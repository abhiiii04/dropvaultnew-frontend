{% extends "base.html" %}
{% block content %}
<div class="main">
  <h1 id="welcomeTitle">Welcome to DropVault</h1>
  <p>Secure. Simple. Yours.</p>

  <div class="dashboard-cards">
    <div class="card">
      <h3>Storage Used</h3>
      <p id="storageText"><strong>0 GB</strong> / 0 GB used</p>
      <div class="progress-container">
        <div class="progress-bar" id="storageBar" style="width: 0%;"></div>
      </div>
    </div>

    <div class="card">
      <h3>Recent Uploads</h3>
      <ul id="recentUploads"><li>Loading...</li></ul>
    </div>

    <div class="card">
      <h3>Shared Files</h3>
      <p id="sharedCount">0 shared this week</p>
    </div>
  </div>

  <div class="table-section">
    <h2>Your Files</h2>
    <table class="dashboard-table">
      <thead>
        <tr>
          <th>Filename</th>
          <th>Expires</th>
          <th>Link</th>
          <th>Download</th>
          <th>QR</th>
        </tr>
      </thead>
      <tbody id="fileTable">
        <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  const API_BASE = "https://dropvault-2.onrender.com"; // backend URL

async function loadDashboard(){
  const token = localStorage.getItem("token");

  // --- Fetch user info first ---
  try {
    const userUrl = `${API_BASE}/api/user/`;
    const userRes = await fetch(userUrl, token ? { headers: { 'Authorization': token }, credentials: 'include' } : { credentials: 'include' });
    if (userRes && userRes.ok) {
      try {
        const u = await userRes.json();
        if (u && (u.username || u.email || u.name)) {
          const name = u.username || u.name || u.email;
          document.getElementById('welcomeTitle').innerText = `Welcome, ${name}`;
        }
        console.log('User data:', u);
      } catch (e) { console.warn('Failed to parse /api/user/ response', e); }
    } else {
      console.log('/api/user/ not available or unauthorized', userRes && userRes.status);
    }
  } catch (e) {
    console.warn('Error fetching /api/user/:', e);
  }

  // Try server dashboard next (keeps existing behavior if available)
  const dashboardUrl = `${API_BASE}/dashboard/`;
  let res;
  try {
    if (token) {
      res = await fetch(dashboardUrl, { method: 'GET', headers: { 'Authorization': token } });
    } else {
      res = await fetch(dashboardUrl, { method: 'GET', credentials: 'include' });
    }
  } catch (e) {
    console.warn('Dashboard endpoint unavailable, will fallback to /api/list/:', e);
    res = null;
  }

  if (res && res.ok) {
    const data = await res.json();
    console.log('DASHBOARD DATA:', data);

    if (data.storage) {
      document.getElementById("storageText").innerHTML =
        `<strong>${data.storage.used} GB</strong> / ${data.storage.total} GB used`;
      document.getElementById("storageBar").style.width = `${data.storage.percent}%`;
    }

    // recent_files may be provided by dashboard
    const recentUI = document.getElementById("recentUploads");
    recentUI.innerHTML = "";
    (data.recent_files || []).forEach(f => recentUI.innerHTML += `<li>${f}</li>`);

    if (typeof data.shared_count !== 'undefined') {
      document.getElementById("sharedCount").innerText = `${data.shared_count} shared this week`;
    }

    const table = document.getElementById("fileTable");
    table.innerHTML = "";
    (data.files || []).forEach(f => {
      table.innerHTML += `
        <tr>
          <td>${f.filename}</td>
          <td>${f.expiry || '-'}</td>
          <td><a href="${f.download_url || (API_BASE + '/api/download/' + f.id + '/') }" target="_blank">Open</a></td>
          <td><a href="${f.download_url || (API_BASE + '/api/download/' + f.id + '/') }" class="btn small">‚¨áÔ∏è</a></td>
          <td>${f.qr ? `<img src="${f.qr}" class="qr-small" alt="QR">` : ''}</td>
        </tr>
      `;
    });

    return;
  }

  // If server indicated a redirect to login (302) or unauthorized, redirect user to frontend login
  if (res && (res.status === 302 || res.status === 401)) {
    console.warn('Dashboard returned auth redirect/status', res.status);
    return window.location.href = '/login';
  }

  // Fallback: use /api/list/ to populate recent uploads and file table
  try {
    const listUrl = `${API_BASE}/api/list/`;
    console.log('üîÑ Falling back to list endpoint:', listUrl);
    console.log('üì§ Token present:', !!token, '(length:', token ? token.length : 0, ')');
    
    const listRes = await fetch(listUrl, token ? { headers: { 'Authorization': token }, credentials: 'include' } : { credentials: 'include' });
    console.log('üì• Response status:', listRes && listRes.status, listRes && listRes.statusText);
    
    if (!listRes || !listRes.ok) {
      console.error('‚ùå Failed to fetch /api/list/:', listRes && listRes.status);
      document.getElementById("recentUploads").innerHTML = "<li>‚ùå Failed to load files</li>";
      return;
    }
    
    const bodyText = await listRes.text();
    console.log('üìÑ Raw response (first 300 chars):', bodyText.substring(0, 300));
    
    // If backend returned HTML (likely login page), redirect to login
    const trimmed = bodyText.trim();
    if (trimmed.startsWith('<') && /login|csrfmiddlewaretoken|name="username"/i.test(trimmed)) {
      console.warn('‚ö†Ô∏è Backend returned HTML login page. Redirecting to /login');
      return window.location.href = '/login';
    }
    let body;
    try { body = JSON.parse(bodyText); } catch (_) { body = { raw: bodyText }; }

    console.log('üîç Parsed response:', body);
    const files = body.files || body.your_files || (Array.isArray(body) ? body : []);
    console.log('üìã Files found:', files.length, files);
    // Use most recent first if created_at exists
    files.sort((a,b) => {
      const ta = a.created_at || a.uploaded_at || a.timestamp || 0;
      const tb = b.created_at || b.uploaded_at || b.timestamp || 0;
      return (tb > ta) ? 1 : ((tb < ta) ? -1 : 0);
    });

    const recentUI = document.getElementById("recentUploads");
    recentUI.innerHTML = "";
    if (!files.length) {
      recentUI.innerHTML = "<li>No files uploaded yet</li>";
      console.log('‚ö†Ô∏è No files in list');
    } else {
      (files.slice(0,5)).forEach(f => {
        const when = f.created_at || f.uploaded_at || f.timestamp || '';
        recentUI.innerHTML += `<li>${f.filename}${when ? ` ‚Äî ${new Date(when).toLocaleString()}` : ''}</li>`;
      });
      console.log('‚úÖ Recent uploads displayed');
    }

    const table = document.getElementById("fileTable");
    table.innerHTML = "";
    files.forEach(f => {
      const downloadUrl = `${API_BASE}/api/download/${f.id}/`;
      table.innerHTML += `
        <tr>
          <td>${f.filename}</td>
          <td>${f.expiry || '-'}</td>
          <td><a href="${downloadUrl}" target="_blank">Open</a></td>
          <td><a href="${downloadUrl}" class="btn small">‚¨áÔ∏è</a></td>
          <td></td>
        </tr>
      `;
    });
  } catch (e) {
    console.error('Error fetching fallback /api/list/:', e);
  }
}

loadDashboard();
</script>

{% endblock %}