{% extends "base.html" %}
{% block content %}
<div class="main">
  <h1 id="welcomeTitle">Welcome to DropVault</h1>
  <p>Secure. Simple. Yours.</p>

  <div class="dashboard-cards">
    <div class="card">
      <h3>Storage Used</h3>
      <p id="storageText"><strong>0 GB</strong> / 0 GB used</p>
      <div class="progress-container">
        <div class="progress-bar" id="storageBar" style="width: 0%;"></div>
      </div>
    </div>

    <div class="card">
      <h3>Recent Uploads</h3>
      <ul id="recentUploads"><li>Loading...</li></ul>
    </div>

    <div class="card">
      <h3>Shared Files</h3>
      <p id="sharedCount">0 shared this week</p>
    </div>
  </div>

  <div class="table-section">
    <h2>Your Files</h2>
    <table class="dashboard-table">
      <thead>
        <tr>
          <th>Filename</th>
          <th>Expires</th>
          <th>Link</th>
          <th>Download</th>
          <th>QR</th>
        </tr>
      </thead>
      <tbody id="fileTable">
        <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const API_BASE = "https://dropvault-2.onrender.com";

async function loadDashboard() {
  const token = localStorage.getItem("token");

  try {
    const userRes = await fetch(`${API_BASE}/api/user/`, {
      headers: token ? { "Authorization": token } : {},
      credentials: "include"
    });
    if (userRes.ok) {
      const u = await userRes.json();
      const name = u.username || u.name || u.email;
      if (name) {
        document.getElementById("welcomeTitle").innerText = `Welcome, ${name}`;
      }
    }
  } catch (e) {
    console.warn("User fetch failed");
  }

  
  try {
    const dashRes = await fetch(`${API_BASE}/dashboard/`, {
      headers: token ? { "Authorization": token } : {},
      credentials: "include"
    });

    if (dashRes.ok) {
      const d = await dashRes.json();
      if (d.storage) {
        document.getElementById("storageText").innerHTML =
          `<strong>${d.storage.used} GB</strong> / ${d.storage.total} GB used`;
        document.getElementById("storageBar").style.width = `${d.storage.percent}%`;
      }
    }
  } catch {
    console.warn("Dashboard stats unavailable");
  }

  
  let files = [];
  try {
    const listRes = await fetch(`${API_BASE}/api/list/`, {
      headers: token ? { "Authorization": token } : {},
      credentials: "include"
    });

    if (!listRes.ok) throw new Error("List failed");

    const listData = await listRes.json();
    files = listData.files || listData.your_files || listData || [];
  } catch (e) {
    console.error("❌ Failed to load files");
  }

  
  const recentUI = document.getElementById("recentUploads");
  recentUI.innerHTML = "";

  if (!files.length) {
    recentUI.innerHTML = "<li>No files uploaded yet</li>";
  } else {
    files
      .slice(0, 5)
      .forEach(f => recentUI.innerHTML += `<li>${f.filename}</li>`);
  }

  
  const table = document.getElementById("fileTable");
  table.innerHTML = "";

  if (!files.length) {
    table.innerHTML = `<tr><td colspan="5" style="text-align:center;">No files found</td></tr>`;
  } else {
    files.forEach(f => {
      const url = `${API_BASE}/api/download/${f.id}/`;
      table.innerHTML += `
        <tr>
          <td>${f.filename}</td>
          <td>${f.expiry || "-"}</td>
          <td><a href="${url}" target="_blank">Open</a></td>
          <td><a href="${url}">⬇️</a></td>
          <td></td>
        </tr>
      `;
    });
  }

  
  try {
    const sharedRes = await fetch(`${API_BASE}/api/shared/`, {
      credentials: "include"
    });

    if (sharedRes.ok) {
      const s = await sharedRes.json();
      const sharedFiles =
        Array.isArray(s) ? s :
        s.shared || s.files || s.results || [];

      document.getElementById("sharedCount").innerText =
        `${sharedFiles.length} shared this week`;
    }
  } catch {
    document.getElementById("sharedCount").innerText = "0 shared this week";
  }
}

loadDashboard();
</script>


{% endblock %}