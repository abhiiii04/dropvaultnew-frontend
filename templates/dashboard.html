{% extends "base.html" %}
{% block content %}

<style>
:root {
  --primary:#6366f1;
  --accent:#8b5cf6;
  --bg:#f8fafc;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#6b7280;
  --radius:18px;
}

.dashboard{
  margin-left:260px;
  padding:30px 40px;
  background:var(--bg);
  min-height:100vh;
  font-family:Inter,system-ui,sans-serif;
}

/* ================= TOP BAR ================= */
.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:25px;
}

.search{
  flex:1;
  max-width:420px;
  height:44px;
  padding:0 16px;
  border-radius:14px;
  border:1px solid #e5e7eb;
  background:#fff;
}

.top-actions{
  display:flex;
  align-items:center;
  gap:18px;
  position:relative;
}

/* ================= NOTIFICATIONS ================= */
.bell{
  position:relative;
  font-size:22px;
  cursor:pointer;
}

.bell span{
  position:absolute;
  top:-6px;
  right:-6px;
  background:#ef4444;
  color:#fff;
  font-size:11px;
  padding:2px 6px;
  border-radius:50%;
}

.dropdown{
  position:absolute;
  top:48px;
  right:0;
  width:280px;
  background:#fff;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
  display:none;
  z-index:10;
}

.dropdown.active{ display:block; }

.dropdown h4{
  padding:14px 16px;
  border-bottom:1px solid #e5e7eb;
}

.dropdown ul{
  list-style:none;
  margin:0;
  padding:8px 0;
}

.dropdown li{
  padding:10px 16px;
  font-size:14px;
  cursor:pointer;
}

.dropdown li:hover{ background:#f1f5f9; }

/* ================= PROFILE ================= */
.profile{
  display:flex;
  align-items:center;
  gap:10px;
  background:#fff;
  padding:6px 12px;
  border-radius:14px;
  cursor:pointer;
}

.avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-weight:700;
}

/* ================= WELCOME ================= */
.welcome h1{
  font-size:30px;
  margin-bottom:6px;
}
.welcome p{ color:var(--muted); }

/* ================= STATS ================= */
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:22px;
  margin:30px 0;
}

.stat-card{
  background:var(--card);
  border-radius:var(--radius);
  padding:22px;
  box-shadow:0 10px 24px rgba(0,0,0,.04);
}

.stat-card h2{ font-size:26px; }
.stat-card span{ color:var(--muted); }

/* ================= STORAGE ================= */
.storage{
  background:var(--card);
  border-radius:var(--radius);
  padding:24px;
}

.bar{
  background:#e5e7eb;
  height:10px;
  border-radius:10px;
  margin-top:10px;
}
.bar-fill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--primary),var(--accent));
  border-radius:10px;
}
</style>

<div class="dashboard">

  <!-- TOP BAR -->
  <div class="topbar">
    <input class="search" placeholder="Search your files..." />

    <div class="top-actions">

      <!-- NOTIFICATION -->
      <div class="bell" onclick="toggleNotif()">
        ðŸ”” <span id="notifCount">0</span>

        <div class="dropdown" id="notifDropdown">
          <h4>Notifications</h4>
          <ul id="notifList">
            <li>Loading...</li>
          </ul>
        </div>
      </div>

      <!-- PROFILE -->
      <div class="profile" onclick="toggleProfile()">
        <div class="avatar" id="avatar">U</div>
        <strong id="profileName" style="color:#000">User</strong>

        <div class="dropdown" id="profileDropdown" style="right:0;">
          <ul>
            <li onclick="location.href='/settings'">âš™ Settings</li>
            <li onclick="logout()">ðŸšª Logout</li>
          </ul>
        </div>
      </div>

    </div>
  </div>

  <!-- WELCOME -->
  <div class="welcome">
    <h1 id="welcomeTitle">Welcome to DropVault</h1>
    <p>Secure. Simple. Yours.</p>
  </div>

  <!-- STATS -->
  <div class="stats">
    <div class="stat-card"><h2 id="totalFiles">0</h2><span>Total Files</span></div>
    <div class="stat-card"><h2 id="imageCount">0</h2><span>Images</span></div>
    <div class="stat-card"><h2 id="docCount">0</h2><span>Documents</span></div>
    <div class="stat-card"><h2 id="videoCount">0</h2><span>Videos</span></div>
  </div>

  <!-- STORAGE -->
  <div class="storage">
    <strong>Storage Used</strong>
    <p id="storageText">0 GB / 0 GB</p>
    <div class="bar"><div class="bar-fill" id="storageBar"></div></div>
  </div>

</div>

<script>
const API="https://dropvault-2.onrender.com";
const token=localStorage.getItem("token");

/* ================= TOGGLES ================= */
function toggleNotif(){
  document.getElementById("notifDropdown").classList.toggle("active");
  document.getElementById("profileDropdown").classList.remove("active");
}
function toggleProfile(){
  document.getElementById("profileDropdown").classList.toggle("active");
  document.getElementById("notifDropdown").classList.remove("active");
}
function logout(){
  localStorage.clear();
  location.href="/login";
}

/* ================= PROFILE ================= */
fetch(`${API}/api/user/profile/`,{headers:{Authorization:token},credentials:"include"})
.then(r=>r.json())
.then(u=>{
  const name=u.username||u.name||"User";
  profileName.innerText=name;
  avatar.innerText=name[0].toUpperCase();
  welcomeTitle.innerText=`Welcome back, ${name} ðŸ‘‹`;
});

/* ================= STORAGE ================= */
fetch(`${API}/api/user/storage/`,{headers:{Authorization:token},credentials:"include"})
.then(r=>r.json())
.then(s=>{
  const used=(s.used_bytes/1024/1024/1024).toFixed(2);
  const total=(s.total_bytes/1024/1024/1024).toFixed(2);
  storageText.innerText=`${used} GB / ${total} GB`;
  storageBar.style.width=`${s.percent||0}%`;
});

/* ================= FILE STATS ================= */
fetch(`${API}/api/files/`,{headers:{Authorization:token},credentials:"include"})
.then(r=>r.json())
.then(d=>{
  const files=d.files||d.your_files||[];
  totalFiles.innerText=files.length;

  let img=0,doc=0,vid=0;
  files.forEach(f=>{
    const e=f.filename.split(".").pop().toLowerCase();
    if(["png","jpg","jpeg"].includes(e)) img++;
    else if(["mp4","mov"].includes(e)) vid++;
    else doc++;
  });

  imageCount.innerText=img;
  docCount.innerText=doc;
  videoCount.innerText=vid;
});

/* ================= NOTIFICATIONS ================= */
fetch(`${API}/api/notifications/`,{headers:{Authorization:token},credentials:"include"})
.then(r=>r.json())
.then(list=>{
  notifCount.innerText=list.length||0;
  notifList.innerHTML=list.length
    ? list.map(n=>`<li>${n.message||"New activity"}</li>`).join("")
    : "<li>No notifications</li>";
});
</script>

{% endblock %}
