{% extends 'base.html' %}
{% block content %}

<style>
.files-wrapper {
  max-width: 750px;
  margin: 40px auto;
  padding: 10px 20px;
}
.section-title {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 25px;
}
.file-list {
  list-style: none;
  padding: 0;
}
.file-item {
  display: flex;
  align-items: center;
  background: #f3f3f8;
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 12px;
}
.file-icon {
  width: 28px;
  margin-right: 14px;
}
.file-actions {
  margin-left: auto;
  display: flex;
  gap: 10px;
}
.file-actions button {
  padding: 6px 10px;
  border-radius: 6px;
}
</style>

<div class="files-wrapper">
  <h1 class="section-title">My Files</h1>
  <ul class="file-list" id="your-files-list">
    <li>Loading...</li>
  </ul>
</div>

<script type="module">
import { API_BASE } from "/static/js/api.js";

const FILE_ICON = "https://cdn-icons-png.flaticon.com/512/337/337946.png";

// üîë Helper: get JWT token (robust lookup)
function getAuthToken() {
  return (
    localStorage.getItem("access") ||
    localStorage.getItem("accessToken") ||
    localStorage.getItem("token") ||
    localStorage.getItem("auth_token")
  );
}

// üö® Helper: handle auth errors
function handleAuthError() {
  alert("‚ö†Ô∏è Session expired or invalid. Please log in again.");
  localStorage.removeItem("access");
  localStorage.removeItem("accessToken");
  localStorage.removeItem("token");
  location.href = "/login";
}

// üì• Load files
async function loadMyFiles() {
  const token = getAuthToken();
  if (!token) return handleAuthError();

  const list = document.getElementById("your-files-list");
  list.innerHTML = "<li>Loading...</li>";

  try {
    const res = await fetch(`${API_BASE}/api/list/`, {
      method: "GET",
      headers: {
        "Authorization": `Bearer ${token}`  // ‚úÖ Critical: Bearer prefix
      }
    });

    if (res.status === 401) {
      handleAuthError();
      return;
    }

    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }

    const data = await res.json();
    const files = data.files || data.your_files || [];

    list.innerHTML = files.length
      ? files.map(f => `
        <li class="file-item">
          <img class="file-icon" src="${FILE_ICON}" alt="File">
          <span>${f.filename}</span>
          <div class="file-actions">
            <button onclick="window.downloadFile('${f.id}')">‚¨áÔ∏è</button>
            <button onclick="window.shareFile('${f.id}')">üîó</button>
            <button onclick="window.deleteFile('${f.id}')">üóë</button>
          </div>
        </li>
      `).join('')
      : "<li>No files uploaded yet</li>";

  } catch (err) {
    console.error("Load failed:", err);
    list.innerHTML = `<li>‚ùå Failed to load files ‚Äî check console</li>`;
  }
}

// üåê Expose functions globally (for inline onclick)
window.downloadFile = async (id) => {
  const token = getAuthToken();
  if (!token) return handleAuthError();

  try {
    const res = await fetch(`${API_BASE}/api/download/${id}/`, {
      method: "GET",
      headers: { "Authorization": `Bearer ${token}` }
    });

    if (res.status === 401) return handleAuthError();
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = ""; // Let backend set filename via Content-Disposition
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  } catch (err) {
    console.error("Download error:", err);
    alert("‚ùå Failed to download file");
  }
};

window.shareFile = async (id) => {
  const token = getAuthToken();
  if (!token) return handleAuthError();

  try {
    const res = await fetch(`${API_BASE}/api/share/`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ file_id: id })
    });

    if (res.status === 401) return handleAuthError();
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    const shareUrl = data.share_url || data.url || data.link;
    if (shareUrl) {
      await navigator.clipboard.writeText(shareUrl);
      alert("üîó Share link copied!");
    } else {
      alert("‚ö†Ô∏è Shared, but no link returned");
    }
  } catch (err) {
    console.error("Share error:", err);
    alert("‚ùå Failed to generate share link");
  }
};

window.deleteFile = async (id) => {
  if (!confirm("Move this file to Trash?")) return;

  const token = getAuthToken();
  if (!token) return handleAuthError();

  try {
    const res = await fetch(`${API_BASE}/api/delete/${id}/`, {
      method: "DELETE",  // ‚úÖ Must be DELETE
      headers: { "Authorization": `Bearer ${token}` }  // ‚úÖ Bearer
      // ‚úÖ No body ‚Äî DELETE should not have one
    });

    if (res.status === 401) return handleAuthError();
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    alert("‚ôªÔ∏è File moved to Trash");
    loadMyFiles(); // refresh
  } catch (err) {
    console.error("Delete error:", err);
    alert("‚ùå Failed to move file to Trash");
  }
};

// üöÄ Start
loadMyFiles();
</script>

{% endblock %}