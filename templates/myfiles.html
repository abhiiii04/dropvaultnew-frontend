{% extends 'base.html' %}
{% block content %}

<style>
.files-wrapper {
  max-width: 750px;
  margin: 40px auto;
  padding: 10px 20px;
}
.section-title {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 25px;
}
.file-list {
  list-style: none;
  padding: 0;
}
.file-item {
  display: flex;
  align-items: center;
  background: #f3f3f8;
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 12px;
}
.file-icon {
  width: 28px;
  margin-right: 14px;
}
.file-actions {
  margin-left: auto;
  display: flex;
  gap: 10px;
}
.file-actions button {
  padding: 6px 10px;
  border-radius: 6px;
}
</style>

<div class="files-wrapper">
  <h1 class="section-title">My Files</h1>
  <ul class="file-list" id="your-files-list">
    <li>Loading...</li>
  </ul>
</div>

<script type="module">
import { API_BASE } from "/static/js/api.js";

const FILE_ICON = "https://cdn-icons-png.flaticon.com/512/337/337946.png";

async function loadMyFiles() {
  const token = localStorage.getItem("token");
  if (!token) return location.href = "/login";

  const list = document.getElementById("your-files-list");

  const res = await fetch(`${API_BASE}/api/list/`, {
    headers: { "Authorization": token },
    credentials: "include"
  });

  const data = await res.json();
  const files = data.files || data.your_files || [];

  list.innerHTML = "";

  if (!files.length) {
    list.innerHTML = "<li>No files uploaded yet</li>";
    return;
  }

 files.forEach(f => {
    list.innerHTML += `
      <li class="file-item">
        <img class="file-icon" src="${FILE_ICON}">
        <span>${f.filename}</span>
        <div class="file-actions">
          <button onclick="downloadFile('${f.id}')">‚¨áÔ∏è</button>
          <button onclick="shareFile('${f.id}')">üîó</button>
          <button onclick="deleteFile('${f.id}')">üóë</button>
        </div>
      </li>
    `;
  });
}

window.downloadFile = (id) => {
  window.open(`${API_BASE}/api/download/${id}/`);
};

window.shareFile = async (id) => {
  const token = localStorage.getItem("token");
  try {
    const res = await fetch(`${API_BASE}/files/share/`, {
      method: "POST",
      headers: {
        "Authorization": token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ file_id: id })
    });

    if (res.ok) {
      const data = await res.json();
      const shareUrl = data.share_url || data.url || data.link;
      if (shareUrl) {
        navigator.clipboard.writeText(shareUrl);
        alert("üîó Share link copied!");
      } else {
     <script type="module">
        import { API_BASE } from "/static/js/api.js";

        const FILE_ICON = "https://cdn-icons-png.flaticon.com/512/337/337946.png";

        async function parseResponse(res) {
          const text = await res.text();
          let data;
          try { data = JSON.parse(text); } catch (_) { data = { raw: text }; }
          if (data && data.login_required) {
            alert(data.error || data.message || "Please login to continue");
            window.location.href = "/login";
            return { authError: true, data };
          }
          return { authError: false, ok: res.ok, status: res.status, data };
        }

        async function loadMyFiles() {
          const token = localStorage.getItem("token");
          if (!token) return window.location.href = "/login";

          const list = document.getElementById("your-files-list");

          const res = await fetch(`${API_BASE}/api/list/`, {
            headers: { "Authorization": token },
            credentials: "include"
          });

          const parsed = await parseResponse(res);
          if (parsed.authError) return;
          if (!parsed.ok) {
            alert(parsed.data.message || "Failed to load files");
            list.innerHTML = "<li>No files uploaded yet</li>";
            return;
          }

          const data = parsed.data;
          const files = data.files || data.your_files || [];

          list.innerHTML = "";

          if (!files.length) {
            list.innerHTML = "<li>No files uploaded yet</li>";
            return;
          }

          files.forEach(f => {
            list.innerHTML += `
              <li class="file-item">
                <img class="file-icon" src="${FILE_ICON}">
                <span>${f.filename}</span>
                <div class="file-actions">
                  <button onclick="downloadFile('${f.id}')">‚¨áÔ∏è</button>
                  <button onclick="shareFile('${f.id}')">üîó</button>
                  <button onclick="deleteFile('${f.id}')">üóë</button>
                </div>
              </li>
            `;
          });
        }

        window.downloadFile = (id) => {
          window.open(`${API_BASE}/api/download/${id}/`);
        };

        window.shareFile = async (id) => {
          const token = localStorage.getItem("token");
          try {
            const res = await fetch(`${API_BASE}/files/share/`, {
              method: "POST",
              headers: {
                "Authorization": token,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ file_id: id }),
              credentials: "include"
            });

            const parsed = await parseResponse(res);
            if (parsed.authError) return;
            if (!parsed.ok) { alert(parsed.data.message || "Failed to share file"); return; }

            const data = parsed.data;
            const shareUrl = data.share_url || data.url || data.link;
            if (shareUrl) {
              await navigator.clipboard.writeText(shareUrl);
              alert("üîó Share link copied!");
            } else {
              alert("‚ùå Failed to retrieve share link");
            }
          } catch (error) {
            console.error("Error sharing file:", error);
            alert("‚ùå An unexpected error occurred while sharing the file.");
          }
        };

        window.deleteFile = async (id) => {
          if (!confirm("Move this file to Trash?")) return;

          const token = localStorage.getItem("token");
          try {
           const res = await fetch(`${API_BASE}/trash/move/`, {
              method: "POST",
              headers: {
                "Authorization": token,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ id }),
              credentials: "include"
            });

            const parsed = await parseResponse(res);
            if (parsed.authError) return;
            if (parsed.ok) {
              alert("‚ôªÔ∏è File moved to Trash");
              loadMyFiles();
            } else {
              alert(parsed.data.message || "‚ùå Failed to move file to Trash");
            }
          } catch (error) {
            console.error("Error moving file to trash:", error);
            alert("‚ùå An unexpected error occurred while moving the file to Trash.");
          }
        };

        loadMyFiles();

        </script>