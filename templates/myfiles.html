{% extends 'base.html' %}
{% block content %}

<div class="myfiles-container">
  <div class="files-page">

    <!-- Header -->
    <div class="page-header">
      <div class="page-title">
        <h1>My Files</h1>
        <p>Manage and organize all your uploaded files</p>
      </div>
      <button class="upload-btn" onclick="location.href='/upload'">â¬† Upload Files</button>
    </div>

    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat"><strong id="totalCount">0</strong><span>Total Files</span></div>
      <div class="stat"><strong id="imgCount">0</strong><span>Images</span></div>
      <div class="stat"><strong id="docCount">0</strong><span>Documents</span></div>
      <div class="stat"><strong id="vidCount">0</strong><span>Videos</span></div>
      <div class="stat"><strong id="shareCount">0</strong><span>Shared</span></div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <input class="search-box" placeholder="Search files...">
      <div class="filter-group">
        <select class="select"><option>All Types</option></select>
        <select class="select"><option>Date (Newest)</option></select>
      </div>
    </div>

    <!-- Files -->
    <div class="file-grid" id="your-files-list">
      <div>Loading...</div>
    </div>

  </div>
</div>

<script type="module">
import { API_BASE } from "/static/js/api.js";

const FILE_ICON = "https://cdn-icons-png.flaticon.com/512/337/337946.png";

async function loadMyFiles() {
  const token = localStorage.getItem("token");
  if (!token) return location.href = "/login";

  const res = await fetch(`${API_BASE}/api/list/`, {
    headers: { Authorization: token },
    credentials: "include"
  });

  const data = await res.json();
  const files = data.files || data.your_files || [];

  document.getElementById("totalCount").innerText = files.length;

  const list = document.getElementById("your-files-list");
  list.innerHTML = "";

  if (!files.length) {
    list.innerHTML = "<p>No files uploaded yet</p>";
    return;
  }

  files.forEach(f => {
    list.innerHTML += `
      <div class="file-card">
        <div class="file-icon"><img src="${FILE_ICON}"></div>
        <div class="file-name">${f.filename}</div>
        <div class="file-meta">${(f.size/1024/1024).toFixed(2)} MB</div>
        <div class="file-actions">
          <button class="btn-download" onclick="window.open('${API_BASE}/api/download/${f.id}/')">â¬‡</button>
          <button class="btn-share" onclick="shareFile('${f.id}')">ðŸ”—</button>
          <button class="btn-delete" onclick="deleteFile('${f.id}')">ðŸ—‘</button>
        </div>
      </div>
    `;
  });
}

window.shareFile = async id => {
  const token = localStorage.getItem("token");
  const res = await fetch(`${API_BASE}/api/share/${id}/`, {
    method: "POST",
    headers: { Authorization: token },
    credentials: "include"
  });
  const data = await res.json();
  await navigator.clipboard.writeText(data.share_url || "");
  alert("ðŸ”— Share link copied");
};

window.deleteFile = async id => {
  if (!confirm("Move this file to Trash?")) return;
  const token = localStorage.getItem("token");
  await fetch(`${API_BASE}/api/delete/${id}/`, {
    method: "DELETE",
    headers: { Authorization: token },
    credentials: "include"
  });
  loadMyFiles();
};

loadMyFiles();
</script>

{% endblock %}