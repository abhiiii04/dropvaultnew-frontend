{% extends 'base.html' %}
{% block content %}

<style>
:root {
  --sidebar-width: 240px;
}

.files-page {
  max-width: 1200px;
  margin: 30px auto;
  padding: 0 20px;
  margin-left: calc(var(--sidebar-width) + 20px);
  box-sizing: border-box;
}

/* Header */
.page-header {
  margin-bottom: 25px;
}

.page-title h1 {
  font-size: 32px;
  font-weight: 700;
}

.page-title p {
  color: #6b7280;
  margin-top: 4px;
}

/* Stats */
.stats-bar {
  background: #ffffff;
  border-radius: 16px;
  padding: 20px;
  display: flex;
  gap: 40px;
  margin-bottom: 25px;
}

.stat {
  text-align: center;
}

.stat strong {
  font-size: 22px;
}

.stat span {
  display: block;
  font-size: 14px;
  color: #6b7280;
}

/* Filters */
.filters {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}

.search-box {
  background: #fff;
  padding: 12px 14px;
  border-radius: 12px;
  width: 320px;
  border: 1px solid #e5e7eb;
}

.filter-group {
  display: flex;
  gap: 12px;
}

.select {
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
}

/* Grid */
.file-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 24px;
}

/* Card */
.file-card {
  background: #ffffff;
  border-radius: 20px;
  padding: 18px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.04);
}

/* Centered icon */
.file-icon {
  width: 60px;
  height: 60px;
  border-radius: 16px;
  background: #f3f4f6;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 14px auto;
}

.file-icon img {
  width: 34px;
}

/* Text */
.file-name {
  font-weight: 600;
  margin-bottom: 4px;
  text-align: center;
}

.file-meta {
  font-size: 13px;
  color: #6b7280;
  text-align: center;
  margin-bottom: 14px;
}

/* Actions */
.file-actions {
  display: flex;
  gap: 10px;
}

.file-actions button {
  flex: 1;
  padding: 10px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
}

.btn-download { background: #eef2ff; color: #4338ca; }
.btn-share { background: #ecfdf5; color: #047857; }
.btn-delete { background: #fee2e2; color: #b91c1c; }
</style>

<div class="main-content">
  <div class="files-page">

    <!-- Header -->
    <div class="page-header">
      <div class="page-title">
        <h1>My Files</h1>
        <p>Manage and organize all your uploaded files</p>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat"><strong id="totalCount">0</strong><span>Total Files</span></div>
      <div class="stat"><strong id="imgCount">0</strong><span>Images</span></div>
      <div class="stat"><strong id="docCount">0</strong><span>Documents</span></div>
      <div class="stat"><strong id="vidCount">0</strong><span>Videos</span></div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <input class="search-box" placeholder="Search files...">
      <div class="filter-group">
        <select class="select"><option>All Types</option></select>
        <select class="select"><option>Date (Newest)</option></select>
      </div>
    </div>

    <!-- Files -->
    <div class="file-grid" id="your-files-list">
      <div>Loading...</div>
    </div>

  </div>
</div>

<script type="module">
import { API_BASE } from "/static/js/api.js";

/* ---------- ICONS ---------- */
const ICONS = {
  image: "https://cdn-icons-png.flaticon.com/512/337/337940.png",
  document: "https://cdn-icons-png.flaticon.com/512/337/337946.png",
  video: "https://cdn-icons-png.flaticon.com/512/337/337948.png",
  other: "https://cdn-icons-png.flaticon.com/512/833/833524.png"
};

/* ---------- HELPERS ---------- */
function getFileType(filename) {
  const ext = filename.split(".").pop().toLowerCase();
  if (["png","jpg","jpeg","gif","webp"].includes(ext)) return "image";
  if (["mp4","mov","avi","mkv"].includes(ext)) return "video";
  if (["pdf","doc","docx","ppt","pptx","xls","xlsx"].includes(ext)) return "document";
  return "other";
}

function formatSize(bytes = 0) {
  return (bytes / 1024 / 1024).toFixed(2) + " MB";
}

function formatDate(date) {
  if (!date) return "Unknown date";
  return new Date(date).toLocaleDateString();
}

/* ---------- MAIN ---------- */
async function loadMyFiles() {
  const token = localStorage.getItem("token");
  if (!token) {
    alert("Session expired. Please login again.");
    return location.href = "/login";
  }

  const res = await fetch(`${API_BASE}/api/list/`, {
    headers: { Authorization: token },
    credentials: "include"
  });

  const data = await res.json();
  console.log("ðŸ“¦ /api/list response:", data);

  /* ðŸ”‘ NORMALIZE RESPONSE */
  let files = [];
  if (Array.isArray(data)) files = data;
  else if (Array.isArray(data.files)) files = data.files;
  else if (Array.isArray(data.your_files)) files = data.your_files;
  else if (Array.isArray(data.results)) files = data.results;

  /* ---------- COUNTS ---------- */
  let img = 0, doc = 0, vid = 0;

  const list = document.getElementById("your-files-list");
  list.innerHTML = "";

  if (!files.length) {
    list.innerHTML = "<p>No files uploaded yet</p>";
    return;
  }

  files.forEach(f => {
    const type = getFileType(f.filename || "");
    if (type === "image") img++;
    if (type === "video") vid++;
    if (type === "document") doc++;

    list.innerHTML += `
      <div class="file-card">
        <div class="file-icon">
          <img src="${ICONS[type]}" />
        </div>

        <div class="file-name">${f.filename}</div>

        <div class="file-meta">
          ${formatSize(f.size)} â€¢ ${formatDate(f.uploaded_at || f.created_at)}
        </div>

        <div class="file-actions">
          <button class="btn-download"
            onclick="window.open('${API_BASE}/api/download/${f.id}/')">â¬‡</button>

          <button class="btn-share"
            onclick="shareFile('${f.id}')">ðŸ”—</button>

          <button class="btn-delete"
            onclick="deleteFile('${f.id}')">ðŸ—‘</button>
        </div>
      </div>
    `;
  });

  /* ---------- UPDATE STATS ---------- */
  document.getElementById("totalCount").innerText = files.length;
  document.getElementById("imgCount").innerText = img;
  document.getElementById("docCount").innerText = doc;
  document.getElementById("vidCount").innerText = vid;
}

/* ---------- ACTIONS ---------- */
window.shareFile = async (id) => {
  const token = localStorage.getItem("token");
  const res = await fetch(`${API_BASE}/api/share/${id}/`, {
    method: "POST",
    headers: { Authorization: token },
    credentials: "include"
  });
  const data = await res.json();
  await navigator.clipboard.writeText(data.share_url || "");
  alert("ðŸ”— Share link copied");
};

window.deleteFile = async (id) => {
  if (!confirm("Move this file to Trash?")) return;
  const token = localStorage.getItem("token");
  await fetch(`${API_BASE}/api/delete/${id}/`, {
    method: "DELETE",
    headers: { Authorization: token },
    credentials: "include"
  });
  loadMyFiles();
};

loadMyFiles();
</script>

{% endblock %}
