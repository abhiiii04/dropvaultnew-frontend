{% extends 'base.html' %}
{% block content %}

<style>
.files-wrapper {
  max-width: 750px;
  margin: 40px auto;
  padding: 10px 20px;
}
.section-title {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 25px;
}
.file-list {
  list-style: none;
  padding: 0;
}
.file-item {
  display: flex;
  align-items: center;
  background: #f3f3f8;
  padding: 12px 16px;
  border-radius: 10px;
  margin-bottom: 12px;
}
.file-icon {
  width: 28px;
  margin-right: 14px;
}
.file-actions {
  margin-left: auto;
  display: flex;
  gap: 10px;
}
.file-actions button {
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  border: 1px solid #ddd;
  background: white;
}
.file-actions button:hover {
  background: #eee;
}
</style>

<div class="files-wrapper">
  <h1 class="section-title">My Files</h1>
  <ul class="file-list" id="your-files-list">
    <li>Loading...</li>
  </ul>
</div>

<script type="module">
import { API_BASE } from "/static/js/api.js";

const FILE_ICON = "https://cdn-icons-png.flaticon.com/512/337/337946.png";

// Attach functions to window object so inline onclick="" can find them
window.downloadFile = (id) => {
  const token = localStorage.getItem("token");
  // If download requires auth, usually handled via a temporary link or attachment
  window.open(`${API_BASE}/api/download/${id}/?token=${token}`);
};

window.shareFile = async (id) => {
  const token = localStorage.getItem("token");
  try {
    // UPDATED ENDPOINT: Using the GET /api/share/<id>/ structure
    const res = await fetch(`${API_BASE}/api/share/${id}/`, {
      method: "GET", // Most Django/FastAPI share creators use GET or a specific POST path
      headers: {
        "Authorization": token
      }
    });

    if (!res.ok) throw new Error("Share failed");

    const data = await res.json();
    
    // Construct the full URL (handling relative vs absolute paths)
    const sharePath = data.share_url || data.link || data.url;
    const fullURL = sharePath.startsWith('http') 
        ? sharePath 
        : `https://dropvault-2.onrender.com${sharePath}`;

    await navigator.clipboard.writeText(fullURL);
    alert("üîó Share link copied to clipboard!\n" + fullURL);
  } catch (err) {
    console.error(err);
    alert("Error: Could not create share link. Check if the file is already shared or endpoint is correct.");
  }
};

window.deleteFile = async (id) => {
  if (!confirm("Move this file to Trash?")) return;
  const token = localStorage.getItem("token");
  
  try {
    const res = await fetch(`${API_BASE}/api/trash/move/`, {
      method: "POST",
      headers: {
        "Authorization": token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ id })
    });
    
    if(res.ok) {
        alert("‚ôªÔ∏è File moved to Trash");
        loadMyFiles();
    }
  } catch (e) { alert("Delete failed"); }
};

async function loadMyFiles() {
  const token = localStorage.getItem("token");
  if (!token) return location.href = "/login";

  const list = document.getElementById("your-files-list");

  try {
    const res = await fetch(`${API_BASE}/api/list/`, {
      headers: { "Authorization": token }
    });

    const data = await res.json();
    const files = data.files || data.your_files || data; // Handle array or object

    list.innerHTML = "";

    if (!Array.isArray(files) || !files.length) {
      list.innerHTML = "<li>No files uploaded yet</li>";
      return;
    }

    files.forEach(f => {
      list.innerHTML += `
        <li class="file-item">
          <img class="file-icon" src="${FILE_ICON}">
          <span>${f.filename}</span>
          <div class="file-actions">
            <button onclick="downloadFile('${f.id}')" title="Download">‚¨áÔ∏è</button>
            <button onclick="shareFile('${f.id}')" title="Share">üîó</button>
            <button onclick="deleteFile('${f.id}')" title="Delete">üóë</button>
          </div>
        </li>
      `;
    });
  } catch (err) {
    list.innerHTML = "<li>Error loading files</li>";
  }
}

// Start loading
loadMyFiles();
</script>

{% endblock %}