{% extends 'base.html' %}
{% block content %}

<style>
/* ================= RESET & LAYOUT ================= */
* {
  box-sizing: border-box; /* Prevents padding from breaking layout */
}

.main-content {
  /* Removed manual margin-left to prevent the 'double space' gap */
  padding: 32px 40px;
  background: #f6f8fc;
  min-height: 100vh;
  width: 100%; /* Fills the remaining space next to sidebar */
}

/* Page wrapper fills space */
.files-page {
  width: 100%;
  max-width: 1600px; /* Prevents content from being too stretched on huge screens */
  margin: 0 auto;
}

/* ================= HEADER ================= */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 28px;
  width: 100%;
}

.page-title h1 {
  font-size: 32px;
  font-weight: 700;
  margin: 0;
}

.page-title p {
  color: #6b7280;
  margin-top: 6px;
}

.upload-btn {
  background: linear-gradient(90deg, #6366f1, #8b5cf6);
  color: #fff;
  padding: 12px 22px;
  border-radius: 14px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  white-space: nowrap;
}

/* ================= STATS ================= */
.stats-bar {
  background: #ffffff;
  border-radius: 18px;
  padding: 22px 32px;
  width: 100%;
  display: flex;
  justify-content: space-between;
  margin-bottom: 28px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.04);
}

.stat {
  text-align: center;
  flex: 1;
}

.stat strong {
  font-size: 22px;
  display: block;
}

.stat span {
  display: block;
  font-size: 14px;
  color: #6b7280;
  margin-top: 4px;
}

/* ================= FILTERS ================= */
.filters {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
  gap: 20px;
  width: 100%;
}

.search-box {
  background: #fff;
  padding: 12px 16px;
  border-radius: 14px;
  flex: 1; /* Search box takes available space */
  max-width: 500px;
  border: 1px solid #e5e7eb;
  outline: none;
}

.filter-group {
  display: flex;
  gap: 12px;
}

.select {
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  background: #fff;
  cursor: pointer;
}

/* ================= GRID ================= */
.file-grid {
  display: grid;
  /* Automatically fits cards based on available width */
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 24px;
  width: 100%;
}

/* ================= FILE CARD ================= */
.file-card {
  background: #ffffff;
  border-radius: 22px;
  padding: 22px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.05);
  transition: transform 0.15s ease, box-shadow 0.15s ease;
  display: flex;
  flex-direction: column;
}

.file-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 28px rgba(0,0,0,0.08);
}

.file-icon {
  width: 56px;
  height: 56px;
  border-radius: 16px;
  background: #fee2e2;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 16px;
}

.file-icon img {
  width: 30px;
}

.file-name {
  font-weight: 600;
  margin-bottom: 6px;
  word-break: break-all;
  font-size: 16px;
}

.file-meta {
  font-size: 13px;
  color: #6b7280;
  margin-bottom: 18px;
}

/* ================= ACTIONS ================= */
.file-actions {
  display: flex;
  gap: 10px;
  margin-top: auto; /* Pushes buttons to bottom of card */
}

.file-actions button {
  flex: 1;
  padding: 10px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: opacity 0.2s;
  font-size: 16px;
}

.file-actions button:hover {
  opacity: 0.8;
}

.btn-download { background: #eef2ff; color: #4338ca; }
.btn-share { background: #ecfdf5; color: #047857; }
.btn-delete { background: #fee2e2; color: #b91c1c; }

/* Responsive adjustments */
@media (max-width: 768px) {
  .filters { flex-direction: column; align-items: stretch; }
  .search-box { max-width: none; }
  .stats-bar { overflow-x: auto; padding: 15px; }
}
</style>

<div class="main-content">
  <div class="files-page">

    <div class="page-header">
      <div class="page-title">
        <h1>My Files</h1>
        <p>Manage and organize all your uploaded files</p>
      </div>
      <button class="upload-btn" onclick="location.href='/upload'">â¬† Upload Files</button>
    </div>

    <div class="stats-bar">
      <div class="stat"><strong id="totalCount">0</strong><span>Total Files</span></div>
      <div class="stat"><strong id="imgCount">0</strong><span>Images</span></div>
      <div class="stat"><strong id="docCount">0</strong><span>Documents</span></div>
      <div class="stat"><strong id="vidCount">0</strong><span>Videos</span></div>
      <div class="stat"><strong id="shareCount">0</strong><span>Shared</span></div>
    </div>

    <div class="filters">
      <input class="search-box" placeholder="Search files...">
      <div class="filter-group">
        <select class="select"><option>All Types</option></select>
        <select class="select"><option>Date (Newest)</option></select>
      </div>
    </div>

    <div class="file-grid" id="your-files-list">
      <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">Loading files...</div>
    </div>

  </div>
</div>

<script type="module">
import { API_BASE } from "/static/js/api.js";

const FILE_ICON = "https://cdn-icons-png.flaticon.com/512/337/337946.png";

async function loadMyFiles() {
  const token = localStorage.getItem("token");
  if (!token) return location.href = "/login";

  try {
    const res = await fetch(`${API_BASE}/api/list/`, {
      headers: { Authorization: token },
      credentials: "include"
    });

    if (!res.ok) throw new Error("Failed to load");

    const data = await res.json();
    const files = data.files || data.your_files || [];

    document.getElementById("totalCount").innerText = files.length;
    // Note: You can add logic here to update imgCount, docCount etc. based on file extensions

    const list = document.getElementById("your-files-list");
    list.innerHTML = "";

    if (files.length === 0) {
      list.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
                          No files uploaded yet. Click upload to get started.
                        </div>`;
      return;
    }

    files.forEach(f => {
      const sizeMB = f.size ? (f.size / 1024 / 1024).toFixed(2) : "0.00";
      list.innerHTML += `
        <div class="file-card">
          <div class="file-icon">
            <img src="${FILE_ICON}" alt="file">
          </div>
          <div class="file-name" title="${f.filename}">${f.filename}</div>
          <div class="file-meta">${sizeMB} MB</div>
          <div class="file-actions">
            <button title="Download" class="btn-download" onclick="downloadFile('${f.download_url || f.share_code}')">â¬‡</button>
            <button title="Share" class="btn-share" onclick="shareFile('${f.id}')">ðŸ”—</button>
            <button title="Delete" class="btn-delete" onclick="deleteFile('${f.id}')">ðŸ—‘</button>
          </div>
        </div>
      `;
    });
  } catch (err) {
    console.error(err);
    document.getElementById("your-files-list").innerHTML = "Error loading files.";
  }
}

/* ================= ACTION HANDLERS ================= */

window.downloadFile = (value) => {
  let url = value;
  if (!value.startsWith("http")) {
    url = `${API_BASE}/s/${value}/download/`;
  }
  window.open(url, "_blank");
};

window.shareFile = async id => {
  const token = localStorage.getItem("token");
  try {
    const res = await fetch(`${API_BASE}/api/share/${id}/`, {
      method: "POST",
      headers: { Authorization: token },
      credentials: "include"
    });
    const data = await res.json();
    await navigator.clipboard.writeText(data.share_url || "");
    alert("ðŸ”— Share link copied to clipboard");
  } catch (err) {
    alert("Could not create share link");
  }
};

window.deleteFile = async id => {
  if (!confirm("Move this file to Trash?")) return;
  const token = localStorage.getItem("token");
  try {
    await fetch(`${API_BASE}/api/delete/${id}/`, {
      method: "DELETE",
      headers: { Authorization: token },
      credentials: "include"
    });
    loadMyFiles();
  } catch (err) {
    alert("Delete failed");
  }
};

// Initial Load
loadMyFiles();
</script>

{% endblock %}