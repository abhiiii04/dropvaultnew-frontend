{% extends "base.html" %}
{% block content %}
<div class="main">
  <h1>Trash</h1>
  <p>Files here will be permanently deleted after 30 days. You can restore them anytime.</p>

  <table class="dashboard-table">
    <thead>
      <tr>
        <th>Filename</th>
        <th>Deleted On</th>
        <th>Days Remaining</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="trashTable">
      <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
    </tbody>
  </table>
</div>

<script>
async function loadTrash() {
  console.log("üßπ loadTrash() called");

  try {
    const res = await fetch(`${API_BASE}/api/trash/`, {
      method: "GET",
      credentials: "include" // ‚úÖ THIS IS THE FIX
    });

    console.log("üì• Trash response status:", res.status);

    if (res.status === 401) {
      alert("Session expired. Please login again.");
      return location.href = "/login";
    }

    const data = await res.json();
    console.log("üìÑ Trash response data:", data);

    const table = document.getElementById("trashTable");

    if (!data.files || data.files.length === 0) {
      table.innerHTML = `
        <tr>
          <td colspan="4" style="text-align:center;">
            No files in trash
          </td>
        </tr>`;
      return;
    }

    table.innerHTML = "";
    data.files.forEach(file => {
      table.innerHTML += `
        <tr>
          <td>${file.filename}</td>
          <td>${new Date(file.deleted_at).toLocaleDateString()}</td>
          <td>${file.days_remaining} days</td>
          <td>
            <button onclick="restoreFile('${file.id}')">‚ôªÔ∏è Restore</button>
            <button onclick="permanentDelete('${file.id}')">üóëÔ∏è Delete</button>
          </td>
        </tr>
      `;
    });

  } catch (err) {
    console.error("‚ùå Error loading trash:", err);
    document.getElementById("trashTable").innerHTML = `
      <tr>
        <td colspan="4" style="text-align:center;color:red;">
          Failed to load trash
        </td>
      </tr>`;
  }
}

async function restoreFile(id) {
  try {
    const res = await fetch(`${API_BASE}/api/restore/${id}/`, {
      method: "POST",
      credentials: "include"
    });

    if (!res.ok) throw new Error(await res.text());

    alert("‚ôªÔ∏è File restored successfully");
    loadTrash();
  } catch (err) {
    console.error("‚ùå Restore error:", err);
    alert("Failed to restore file");
  }
}

async function permanentDelete(id) {
  if (!confirm("‚ö†Ô∏è Permanently delete this file?")) return;

  try {
    const res = await fetch(`${API_BASE}/api/delete/${id}/`, {
      method: "DELETE",
      credentials: "include"
    });

    if (!res.ok) throw new Error(await res.text());

    alert("üóëÔ∏è File permanently deleted");
    loadTrash();
  } catch (err) {
    console.error("‚ùå Delete error:", err);
    alert("Failed to permanently delete file");
  }
}

document.addEventListener("DOMContentLoaded", loadTrash);
</script>



{% endblock %}