{% extends "base.html" %}
{% block content %}
<div class="main">
  <h1>Trash</h1>
  <p>Files here will be permanently deleted after 30 days. You can restore them anytime.</p>

  <table class="dashboard-table">
    <thead>
      <tr>
        <th>Filename</th>
        <th>Deleted On</th>
        <th>Days Remaining</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="trashTable">
      <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
    </tbody>
  </table>
</div>

<script>
const API_BASE = "https://dropvault-2.onrender.com";

async function loadTrash() {
  console.log("üßπ loadTrash() called");

  const token = localStorage.getItem("token");
  if (!token) {
    alert("Session expired. Please login again.");
    return location.href = "/login";
  }

  try {
    const res = await fetch(`${API_BASE}/api/trash/`, {
      method: "GET",
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    console.log("üì• Trash response status:", res.status);

    const data = await res.json();
    console.log("üìÑ Trash response data:", data);

    const table = document.getElementById("trashTable");

    if (!res.ok) {
      table.innerHTML = `<tr><td colspan="4">Failed to load trash</td></tr>`;
      return;
    }

    if (!data.files || data.files.length === 0) {
      table.innerHTML = `<tr><td colspan="4" style="text-align:center;">No files in trash</td></tr>`;
      return;
    }

    table.innerHTML = "";

    data.files.forEach(file => {
      table.innerHTML += `
        <tr>
          <td>${file.filename}</td>
          <td>${new Date(file.deleted_at).toLocaleDateString()}</td>
          <td>${file.days_remaining} days</td>
          <td>
            <button onclick="restoreFile('${file.id}')">‚ôªÔ∏è Restore</button>
            <button onclick="deleteFile('${file.id}')">üóëÔ∏è Delete Permanently</button>
          </td>
        </tr>
      `;
    });

  } catch (err) {
    console.error("‚ùå Trash load error:", err);
    document.getElementById("trashTable").innerHTML =
      `<tr><td colspan="4">Error loading trash</td></tr>`;
  }
}

async function restoreFile(id) {
  const token = localStorage.getItem("token");

  const res = await fetch(`${API_BASE}/api/restore/${id}/`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${token}`
    }
  });

  if (!res.ok) {
    alert("Restore failed");
    return;
  }

  alert("‚ôªÔ∏è File restored");
  loadTrash();
}

async function deleteFile(id) {
  if (!confirm("Permanently delete this file?")) return;

  const token = localStorage.getItem("token");

  const res = await fetch(`${API_BASE}/api/delete/${id}/`, {
    method: "DELETE",
    headers: {
      "Authorization": `Bearer ${token}`
    }
  });

  if (!res.ok) {
    alert("Delete failed");
    return;
  }

  alert("üóëÔ∏è File permanently deleted");
  loadTrash();
}

document.addEventListener("DOMContentLoaded", loadTrash);
</script>

{% endblock %}