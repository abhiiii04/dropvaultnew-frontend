{% extends "base.html" %}
{% block content %}
<div class="main">
  <h1>Trash</h1>
  <p>Files here will be permanently deleted after 30 days. You can restore them anytime.</p>

  <table class="dashboard-table">
    <thead>
      <tr>
        <th>Filename</th>
        <th>Deleted On</th>
        <th>Days Remaining</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="trashTable">
      <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
    </tbody>
  </table>
</div>

<script>
// Ensure we don't redeclare a global API_BASE (prevents duplicate-const errors)
if (typeof API_BASE === 'undefined') { var API_BASE = "https://dropvault-2.onrender.com"; }

// Read a cookie value by name (used to get CSRF token if backend provides it)
function getCookie(name) {
  const v = `; ${document.cookie}`;
  const parts = v.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}

async function loadTrash() {
  const token = localStorage.getItem("token");
  if (!token) return location.href = "/login";

  try {
    const headers = {};
    const csrftoken = getCookie('csrftoken');
    if (csrftoken) headers['X-CSRFToken'] = csrftoken;
    // include Authorization if available (some backends accept either)
    if (token) headers['Authorization'] = token;

    const res = await fetch(`${API_BASE}/api/trash/`, {
      credentials: 'include',
      headers
    });

    if (!res.ok) {
      throw new Error(`Failed to load trash: ${res.status}`);
    }

    const data = await res.json();
    const table = document.getElementById("trashTable");

    // ‚úÖ FIXED: Use data.files (not data.trash)
    if (!data.files || data.files.length === 0) {
      table.innerHTML = `<tr><td colspan="4" style="text-align:center;">No files in trash</td></tr>`;
      return;
    }

    table.innerHTML = data.files.map(file => {
      // ‚úÖ FIXED: Use file.deleted_at (not deleted_on)
      const deletedDate = new Date(file.deleted_at);
      const formattedDate = deletedDate.toLocaleDateString(); // e.g., "1/2/2026"

      return `
        <tr>
          <td>${file.filename}</td>
          <td>${formattedDate}</td>
          <td>${file.days_remaining} days</td>
          <td>
            <button onclick="restoreFile('${file.id}')" class="btn small restore-btn">‚ôªÔ∏è Restore</button>
            <button onclick="deleteFile('${file.id}')" class="btn small delete-btn">üóëÔ∏è Delete Permanently</button>
          </td>
        </tr>
      `;
    }).join('');
  } catch (err) {
    console.error("Error loading trash:", err);
    document.getElementById("trashTable").innerHTML = 
      `<tr><td colspan="4" style="text-align:center;color:red;">Error loading trash. Check console.</td></tr>`;
  }
}

async function restoreFile(id) {
  const token = localStorage.getItem("token");
  if (!token) return alert("Not logged in");

  try {
    // ‚úÖ FIXED: Use correct endpoint ‚Äî /api/restore/<id>/ (POST, no body)
    const headers = { 'Content-Type': 'application/json' };
    const csrftoken = getCookie('csrftoken');
    if (csrftoken) headers['X-CSRFToken'] = csrftoken;
    if (token) headers['Authorization'] = token;

    const res = await fetch(`${API_BASE}/api/restore/${id}/`, {
      method: "POST",
      credentials: 'include',
      headers,
      body: JSON.stringify({})
    });

    if (!res.ok) {
      const errText = await res.text();
      throw new Error(`Restore failed (${res.status}): ${errText}`);
    }

    alert("‚ôªÔ∏è File Restored!");
    loadTrash();
  } catch (err) {
    console.error("Restore error:", err);
    alert("‚ùå Failed to restore file. See console for details.");
  }
}

async function deleteFile(id) {
  if (!confirm("‚ö†Ô∏è Permanently delete this file? This cannot be undone.")) return;

  const token = localStorage.getItem("token");
  if (!token) return alert("Not logged in");

  try {
    console.log('üóëÔ∏è Permanently deleting file ID:', id);
    const url = `${API_BASE}/api/delete/${id}/`;
    console.log('üì§ Calling:', url);

    const headers = {};
    const csrftoken = getCookie('csrftoken');
    if (csrftoken) headers['X-CSRFToken'] = csrftoken;
    if (token) headers['Authorization'] = token;

    const res = await fetch(url, {
      method: 'DELETE',
      credentials: 'include',
      headers
    });

    console.log('üì• Response status:', res.status, res.statusText);
    const text = await res.text();
    console.log('üìÑ Response body:', text.substring(0, 200));

    let data;
    try { 
      data = JSON.parse(text); 
    } catch (_) { 
      data = { raw: text }; 
    }

    if (res.ok) {
      console.log('‚úÖ File permanently deleted');
      alert('üóëÔ∏è File Permanently Deleted!');
      loadTrash();
      return;
    }

    const errMsg = data.message || data.error || text || 'Failed to delete file';
    console.error('‚ùå Error:', errMsg, '(status:', res.status + ')');
    alert(`‚ùå ${errMsg} (status: ${res.status})`);

  } catch (err) {
    console.error('‚ùå Error deleting file:', err);
    alert('‚ùå An unexpected error occurred while deleting the file.');
  }
}

// Informational handler when backend doesn't support permanent-delete
function unavailablePermanentDelete(id) {
  alert('Permanent delete is not supported by the server API.\n\nOptions:\n- Permanently delete via the backend admin or DB, or\n- Add a permanent-delete endpoint (e.g. DELETE /api/delete/<id>/?permanent=true) on the server.');
}

// Load on page ready
document.addEventListener("DOMContentLoaded", loadTrash);
</script>
{% endblock %}