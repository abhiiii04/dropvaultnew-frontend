{% extends 'base.html' %}
{% block content %}

<div class="settings-container">
  <h1>Account Settings</h1>
  <p>Manage your account, storage, privacy, and preferences.</p>

  <div class="settings-grid">

    <!-- PROFILE -->
    <section class="settings-card">
      <h2>Profile</h2>
      <form id="profileForm">
        <label>Username</label>
        <input type="text" id="username" required>

        <label>Email</label>
        <input type="email" id="email" required>

        <button type="submit" class="btn-save">Save Profile</button>
      </form>
    </section>

    <!-- STORAGE -->
    <section class="settings-card">
      <h2>Storage</h2>

      <div class="storage-progress">
        <div id="storageBar" class="progress-bar" style="width:0%"></div>
      </div>

      <p>
        <strong id="usedStorage">0 B</strong>
        of
        <strong id="totalStorage">0 B</strong>
      </p>

      <!-- âœ… UPDATED BUTTON (MATCHES SAVE / UPDATE STYLE) -->
      <button
        type="button"
        class="btn-save"
        onclick="location.href='/files'">
        Manage Files
      </button>
    </section>

    <!-- SECURITY -->
    <section class="settings-card">
      <h2>Security</h2>
      <form id="passwordForm">
        <label>Change Password</label>
        <input type="password" id="newPassword" placeholder="Enter new password">
        <button class="btn-save" type="submit">Update Password</button>
      </form>
    </section>

    <!-- PREFERENCES -->
    <section class="settings-card">
      <h2>Preferences</h2>
      <form id="prefsForm">
        <label>Theme</label>
        <select id="themeSelect">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>

        <label>Notifications</label>
        <select id="notifySelect">
          <option value="all">All</option>
          <option value="important">Important Only</option>
          <option value="none">None</option>
        </select>

        <button type="submit" class="btn-save">Save Preferences</button>
      </form>
    </section>

  </div>
</div>

<script>
const API = "https://dropvault-backend.onrender.com";

/* âœ… SAME TOKEN LOGIC AS DASHBOARD */
const storedToken =
  localStorage.getItem("token") ||
  localStorage.getItem("authToken");

const token = storedToken
  ? (storedToken.startsWith("Token ") ? storedToken : `Token ${storedToken}`)
  : null;

if (!token) {
  window.location.href = "/login";
}

/* âœ… SHARED API CALL */
async function apiCall(endpoint, options = {}) {
  const res = await fetch(`${API}${endpoint}`, {
    ...options,
    headers: {
      "Authorization": token,
      "Accept": "application/json",
      "Content-Type": "application/json"
    },
    credentials: "include"
  });

  if (res.status === 401) {
    localStorage.clear();
    window.location.href = "/login";
    return null;
  }

  return res.json();
}

/* ================= PROFILE ================= */
async function loadProfile() {
  const data = await apiCall("/api/user/");

  if (data && data.success) {
    const user = data.data || data.user || {};
    document.getElementById("username").value =
      user.username || user.name || "";
    document.getElementById("email").value =
      user.email || "";
  }
}

/* ================= STORAGE (MATCH DASHBOARD) ================= */
async function loadStorage() {
  const data = await apiCall("/api/user/storage/");

  if (data && data.success && data.storage) {
    const s = data.storage;

    document.getElementById("usedStorage").innerText =
      s.used_formatted || "0 B";

    document.getElementById("totalStorage").innerText =
      s.limit_formatted || "10 GB";

    document.getElementById("storageBar").style.width =
      `${Math.min(s.percentage || 0, 100)}%`;
  }
}

/* ================= UPDATE PROFILE ================= */
document.getElementById("profileForm").addEventListener("submit", async e => {
  e.preventDefault();
  alert("Profile update endpoint not enabled yet.");
});

/* ================= PASSWORD ================= */
document.getElementById("passwordForm").addEventListener("submit", async e => {
  e.preventDefault();

  const password = document.getElementById("newPassword").value;
  if (!password) return alert("Enter a password");

  const res = await apiCall("/api/reset-password/", {
    method: "POST",
    body: JSON.stringify({ password })
  });

  if (res) {
    alert("Password updated ðŸ”’");
    e.target.reset();
  }
});

/* ================= PREFERENCES ================= */
document.getElementById("prefsForm").addEventListener("submit", async e => {
  e.preventDefault();
  alert("Preferences API not implemented yet.");
});

/* ================= LOAD ALL ================= */
async function loadSettings() {
  await loadProfile();
  await loadStorage();
}

loadSettings();
</script>

{% endblock %}
