{% extends 'base.html' %}
{% block content %}
<div class="settings-container">
  <h1>Account Settings</h1>
  <p>Manage your account, storage, privacy, and preferences.</p>

  <div class="settings-grid">

    <!-- PROFILE INFO -->
    <section class="settings-card">
      <h2>Profile</h2>
      <form id="profileForm">
        <label>Username</label>
        <input type="text" id="username" required>

        <label>Email</label>
        <input type="email" id="email" required>

        <label>Profile Picture</label>
        <input type="file" id="avatar">

        <button type="submit" class="btn-save">Save Profile</button>
      </form>
    </section>

    <!-- STORAGE -->
    <section class="settings-card">
      <h2>Storage</h2>
      <div class="storage-progress">
        <div id="storageBar" class="progress-bar" style="width: 0%;"></div>
      </div>
      <p><strong id="usedStorage">0 MB</strong> of <strong id="totalStorage">0 MB</strong> used</p>
      <button class="btn-manage">Manage Files</button>
    </section>

    <!-- SECURITY -->
    <section class="settings-card">
      <h2>Security</h2>
      <form id="passwordForm">
        <label>Change Password</label>
        <input type="password" id="newPassword" placeholder="Enter new password">
        <button class="btn-save" type="submit">Update Password</button>
      </form>

      <br>
      <button id="toggle2FA" class="btn-enable">Toggle 2FA</button>
    </section>

    <!-- PREFERENCES -->
    <section class="settings-card">
      <h2>Preferences</h2>
      <form id="prefsForm">
        <label>Theme</label>
        <select id="themeSelect">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>

        <label>Notifications</label>
        <select id="notifySelect">
          <option value="all">All</option>
          <option value="important">Important Only</option>
          <option value="none">None</option>
        </select>

        <button type="submit" class="btn-save">Save Preferences</button>
      </form>
    </section>

  </div>
</div>


<!-- üöÄ FRONTEND API CALLS (Render Connected) -->
<script type="module">
import { API_BASE } from "/static/js/api.js";

const token = localStorage.getItem("token");
if (!token) location.href = "/login";


/* ---------------- LOAD USER DATA ---------------- */
async function loadSettings(){
  const res = await fetch(`${API_BASE}/user/profile`, {
    headers: { "Authorization": token }
  });
  const data = await res.json();

  document.getElementById("username").value = data.username;
  document.getElementById("email").value = data.email;
  document.getElementById("themeSelect").value = data.theme;
  document.getElementById("notifySelect").value = data.notifications;

  document.getElementById("storageBar").style.width = `${data.storage.percent}%`;
  document.getElementById("usedStorage").innerText = `${data.storage.used} MB`;
  document.getElementById("totalStorage").innerText = `${data.storage.total} MB`;
}
loadSettings();


/* ---------------- UPDATE PROFILE ---------------- */
document.getElementById("profileForm").addEventListener("submit", async(e)=>{
  e.preventDefault();
  const username = document.getElementById("username").value;
  const email = document.getElementById("email").value;

  const res = await fetch(`${API_BASE}/user/profile/update`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": token },
    body: JSON.stringify({ username, email })
  });

  alert(res.ok ? "Profile Updated ‚úîÔ∏è" : "Update Failed ‚ùå");
});


/* ---------------- CHANGE PASSWORD ---------------- */
document.getElementById("passwordForm").addEventListener("submit", async(e)=>{
  e.preventDefault();
  const password = document.getElementById("newPassword").value;

  const res = await fetch(`${API_BASE}/user/password/update`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": token },
    body: JSON.stringify({ password })
  });

  alert(res.ok ? "Password Updated üîí" : "Error ‚ùå");
});


/* ---------------- TOGGLE 2FA ---------------- */
document.getElementById("toggle2FA").addEventListener("click", async()=>{
  const res = await fetch(`${API_BASE}/user/2fa/toggle`, {
    method: "POST",
    headers: { "Authorization": token }
  });

  alert(res.ok ? "2FA Toggled üîê" : "Request Failed ‚ùå");
  loadSettings();
});


/* ---------------- UPDATE PREFERENCES ---------------- */
document.getElementById("prefsForm").addEventListener("submit", async(e)=>{
  e.preventDefault();
  const theme = document.getElementById("themeSelect").value;
  const notifications = document.getElementById("notifySelect").value;

  const res = await fetch(`${API_BASE}/user/preferences/update`, {
    method: "POST",
    headers: { "Content-Type":"application/json", "Authorization": token },
    body: JSON.stringify({ theme, notifications })
  });

  alert(res.ok ? "Preferences Saved üé®" : "Update Failed ‚ùå");
});
</script>

{% endblock %}
