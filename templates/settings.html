{% extends 'base.html' %}
{% block content %}

<div class="settings-container">
  <h1>Account Settings</h1>
  <p>Manage your account, storage, security, and preferences.</p>

  <div class="settings-grid">

```
<!-- PROFILE -->
<section class="settings-card">
  <h2>Profile</h2>
  <form id="profileForm">
    <label>Username</label>
    <input type="text" id="username" required>

    <label>Email</label>
    <input type="email" id="email" required>

    <button type="submit" class="btn-save">Save Profile</button>
  </form>
</section>

<!-- STORAGE -->
<section class="settings-card">
  <h2>Storage</h2>
  <div class="storage-progress">
    <div id="storageBar" class="progress-bar"></div>
  </div>
  <p>
    <strong id="usedStorage">0 MB</strong> of
    <strong id="totalStorage">0 MB</strong> used
  </p>
  <button class="btn-manage" onclick="location.href='/dashboard'">
    Manage Files
  </button>
</section>

<!-- SECURITY -->
<section class="settings-card">
  <h2>Security</h2>
  <form id="passwordForm">
    <label>Change Password</label>
    <input type="password" id="newPassword" placeholder="Enter new password">
    <button type="submit" class="btn-save">Update Password</button>
  </form>

  <br>
  <button id="toggle2FA" class="btn-enable">Toggle 2FA</button>
</section>

<!-- PREFERENCES -->
<section class="settings-card">
  <h2>Preferences</h2>
  <form id="prefsForm">
    <label>Theme</label>
    <select id="themeSelect">
      <option value="light">Light</option>
      <option value="dark">Dark</option>
    </select>

    <label>Notifications</label>
    <select id="notifySelect">
      <option value="all">All</option>
      <option value="important">Important Only</option>
      <option value="none">None</option>
    </select>

    <button type="submit" class="btn-save">Save Preferences</button>
  </form>
</section>
```

  </div>
</div>

<script>
const API = "https://dropvault-2.onrender.com";
const token = localStorage.getItem("token");

if (!token) {
  location.href = "/login";
}

/* ================= SAFE FETCH ================= */
async function apiFetch(url, options = {}) {
  const headers = options.headers || {};
  headers["Accept"] = "application/json";
  headers["Authorization"] = `Bearer ${token}`;

  const res = await fetch(url, {
    ...options,
    headers,
    credentials: "include"
  });

  if (res.status === 401 || res.status === 403) {
    alert("Session expired. Please login again.");
    localStorage.removeItem("token");
    location.href = "/login";
    throw new Error("Unauthorized");
  }

  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

/* ================= LOAD PROFILE + STORAGE ================= */
async function loadSettings() {
  try {
    /* PROFILE */
    const profile = await apiFetch(`${API}/api/user/profile/`);
    document.getElementById("username").value =
      profile.username || profile.name || "";
    document.getElementById("email").value =
      profile.email || "";

    /* STORAGE */
    const storage = await apiFetch(`${API}/api/user/storage/`);

    let usedMB = 0;
    let totalMB = 0;
    let percent = 0;

    if (storage.used_bytes && storage.total_bytes) {
      usedMB = (storage.used_bytes / 1024 / 1024).toFixed(2);
      totalMB = (storage.total_bytes / 1024 / 1024).toFixed(2);
      percent = (storage.used_bytes / storage.total_bytes) * 100;
    }

    document.getElementById("usedStorage").innerText = `${usedMB} MB`;
    document.getElementById("totalStorage").innerText = `${totalMB} MB`;
    document.getElementById("storageBar").style.width =
      `${Math.min(percent, 100)}%`;

  } catch (err) {
    console.error("Failed to load settings:", err);
  }
}

loadSettings();

/* ================= UPDATE PROFILE (READ-ONLY BACKEND) ================= */
document.getElementById("profileForm").addEventListener("submit", e => {
  e.preventDefault();
  alert("Profile update is not enabled in backend yet âš ï¸");
});

/* ================= PASSWORD CHANGE ================= */
document.getElementById("passwordForm").addEventListener("submit", async e => {
  e.preventDefault();
  const password = document.getElementById("newPassword").value;

  if (!password) return alert("Enter a new password");

  try {
    await apiFetch(`${API}/api/reset-password/`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password })
    });

    alert("Password updated ðŸ”’");
    e.target.reset();
  } catch {
    alert("Password update failed âŒ");
  }
});

/* ================= TOGGLE 2FA ================= */
document.getElementById("toggle2FA").addEventListener("click", async () => {
  try {
    await apiFetch(`${API}/api/user/2fa/toggle/`, { method: "POST" });
    alert("2FA toggled ðŸ”");
  } catch {
    alert("2FA feature not enabled in backend âŒ");
  }
});

/* ================= SAVE PREFERENCES (UI ONLY) ================= */
document.getElementById("prefsForm").addEventListener("submit", e => {
  e.preventDefault();
  alert("Preferences saved (UI only) ðŸŽ¨");
});
</script>

{% endblock %}
