{% extends 'base.html' %}
{% block content %}
<div class="settings-container">
  <h1>Account Settings</h1>
  <p>Manage your account, storage, privacy, and preferences.</p>

  <div class="settings-grid">

    
    <section class="settings-card">
      <h2>Profile</h2>
      <form id="profileForm">
        <label>Username</label>
        <input type="text" id="username" required>

        <label>Email</label>
        <input type="email" id="email" required>

        <label>Profile Picture</label>
        <input type="file" id="avatar">

        <button type="submit" class="btn-save">Save Profile</button>
      </form>
    </section>

    
    <section class="settings-card">
      <h2>Storage</h2>
      <div class="storage-progress">
        <div id="storageBar" class="progress-bar" style="width: 0%;"></div>
      </div>
      <p><strong id="usedStorage">0 MB</strong> of <strong id="totalStorage">0 MB</strong> used</p>
      <button class="btn-manage">Manage Files</button>
    </section>

   
    <section class="settings-card">
      <h2>Security</h2>
      <form id="passwordForm">
        <label>Change Password</label>
        <input type="password" id="newPassword" placeholder="Enter new password">
        <button class="btn-save" type="submit">Update Password</button>
      </form>

      <br>
      <button id="toggle2FA" class="btn-enable">Toggle 2FA</button>
    </section>

   
    <section class="settings-card">
      <h2>Preferences</h2>
      <form id="prefsForm">
        <label>Theme</label>
        <select id="themeSelect">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>

        <label>Notifications</label>
        <select id="notifySelect">
          <option value="all">All</option>
          <option value="important">Important Only</option>
          <option value="none">None</option>
        </select>

        <button type="submit" class="btn-save">Save Preferences</button>
      </form>
    </section>

  </div>
</div>



<script type="module">
import { API_BASE } from "/static/js/api.js";

const token = localStorage.getItem("token");

/* ================= SAFE FETCH (SESSION + JWT) ================= */
async function apiFetch(url, options = {}) {
  const headers = options.headers || {};
  headers["Accept"] = "application/json";

  if (token) {
    headers["Authorization"] = `Bearer ${token}`;
  }

  const res = await fetch(url, {
    ...options,
    headers,
    credentials: "include" 
  });

  if (res.status === 401 || res.status === 403) {
    alert("Session expired. Please login again.");
    location.href = "/login";
    throw new Error("Unauthorized");
  }

  if (!res.ok) {
    throw new Error(`HTTP ${res.status}`);
  }

  return res.json();
}

/* ================= LOAD SETTINGS ================= */
async function loadSettings() {
  try {
    /* -------- PROFILE -------- */
    const profile = await apiFetch(`${API_BASE}/api/user/profile/`);

    document.getElementById("username").value =
      profile.username || profile.name || "";

    document.getElementById("email").value =
      profile.email || "";

    /* -------- STORAGE -------- */
    const storage = await apiFetch(`${API_BASE}/api/user/storage/`);

    let usedMB = 0;
    let totalMB = 0;
    let percent = 0;

    if (storage.used_bytes && storage.total_bytes) {
      usedMB = (storage.used_bytes / 1024 / 1024).toFixed(2);
      totalMB = (storage.total_bytes / 1024 / 1024).toFixed(2);
      percent = (storage.used_bytes / storage.total_bytes) * 100;
    } else {
      usedMB = storage.used || 0;
      totalMB = storage.total || 0;
      percent = storage.percent || 0;
    }

    document.getElementById("usedStorage").innerText = `${usedMB} MB`;
    document.getElementById("totalStorage").innerText = `${totalMB} MB`;
    document.getElementById("storageBar").style.width =
      `${Math.min(percent, 100)}%`;

  } catch (err) {
    console.error("Settings load failed:", err);
  }
}

loadSettings();

/* ================= UPDATE PROFILE ================= */
document.getElementById("profileForm").addEventListener("submit", async e => {
  e.preventDefault();

  const username = document.getElementById("username").value;
  const email = document.getElementById("email").value;

  try {
    await apiFetch(`${API_BASE}/api/user/profile/`, {
      method: "PUT",   
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, email })
    });

    alert("Profile updated ‚úîÔ∏è");
  } catch {
    alert("Profile update failed ‚ùå");
  }
});

/* ================= CHANGE PASSWORD ================= */
document.getElementById("passwordForm").addEventListener("submit", async e => {
  e.preventDefault();

  const password = document.getElementById("newPassword").value;
  if (!password) return alert("Enter a password");

  try {
    await apiFetch(`${API_BASE}/api/reset-password/`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password })
    });

    alert("Password updated üîí");
    e.target.reset();
  } catch {
    alert("Password update failed ‚ùå");
  }
});

/* ================= TOGGLE 2FA ================= */
document.getElementById("toggle2FA").addEventListener("click", async () => {
  try {
    await apiFetch(`${API_BASE}/api/user/2fa/toggle/`, {
      method: "POST"
    });

    alert("2FA toggled üîê");
  } catch {
    alert("2FA request failed ‚ùå");
  }
});

/* ================= SAVE PREFERENCES ================= */
document.getElementById("prefsForm").addEventListener("submit", async e => {
  e.preventDefault();

  const theme = document.getElementById("themeSelect").value;
  const notifications = document.getElementById("notifySelect").value;

  try {
    await apiFetch(`${API_BASE}/api/user/preferences/update/`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ theme, notifications })
    });

    alert("Preferences saved üé®");
  } catch {
    alert("Preferences update failed ‚ùå");
  }
});
</script>


{% endblock %}
